# 需求文档

## 引言

自适应混合索引（Adaptive Hybrid Indexing）是一种新型的检索增强生成（RAG）索引方法，旨在根据查询特征和文档特性动态选择最优索引路径，并在检索过程中进行自适应调整。该方法不是简单地将多种索引结果融合，而是智能地选择和组合最适合特定查询的索引方法，从而提高检索的准确性和效率。

本项目的目标是在现有RAG系统的基础上，实现自适应混合索引功能，并通过实验证明其在多个数据集上的有效性。该方法特别适用于CPU环境下的高效检索，无需依赖大量GPU资源。

## 需求

### 需求1：索引层面优化

**用户故事:** 作为一名RAG系统开发者，我希望能够使用更高效的索引结构，以便在CPU环境下也能获得良好的检索性能。

#### 验收标准

1. 当系统初始化时，系统应支持HNSW（Hierarchical Navigable Small World）或IVF（Inverted File）索引结构，替代原有的IndexFlatIP。
2. 当使用HNSW索引时，系统应提供参数配置选项，包括M（最大出边数）和efConstruction（构建时的搜索深度）。
3. 当在CPU环境下运行时，系统应能在保持相似检索质量的同时，检索速度比原始IndexFlatIP提升至少30%。
4. 如果用户提供了现有的FAISS索引，系统应能够加载并转换为优化后的索引结构。

### 需求2：BM25语义增强

**用户故事:** 作为一名RAG系统用户，我希望传统的BM25检索能够理解语义相似性，以便获得更准确的检索结果。

#### 验收标准

1. 当系统构建BM25索引时，系统应使用轻量级语义模型（如MiniLM）为关键词添加语义信息。
2. 当执行查询时，系统应结合关键词匹配和语义相似度计算文档得分。
3. 当评估检索结果时，语义增强的BM25应在保持高效率的同时，在准确率指标上比原始BM25提高至少5%。
4. 如果查询包含同义词或相关概念，系统应能够检索到相关文档，即使文档中不包含查询中的确切关键词。

### 需求3：查询特征分析与自适应索引选择

**用户故事:** 作为一名RAG系统用户，我希望系统能够根据我的查询特点自动选择最合适的索引方法，以便获得最佳的检索体验。

#### 验收标准

1. 当接收到查询时，系统应分析查询的特征，包括但不限于：查询长度、实体数量、语义复杂度等。
2. 基于查询特征，系统应自动选择最适合的索引方法或索引组合。
3. 当查询是简短的关键词查询时，系统应优先使用BM25索引。
4. 当查询是语义复杂的自然语言问题时，系统应优先使用向量索引。
5. 当查询具有混合特征时，系统应使用多种索引方法并进行自适应融合。
6. 系统应记录不同类型查询的性能表现，并用于优化未来的索引选择决策。

### 需求4：自适应融合策略

**用户故事:** 作为一名RAG系统开发者，我希望系统能够智能地融合多种索引的结果，以便最大化检索性能。

#### 验收标准

1. 当系统决定使用多种索引时，系统应根据查询特征动态调整各索引结果的融合权重。
2. 当评估检索性能时，自适应融合策略应比固定权重融合在MRR和NDCG指标上提高至少3%。
3. 系统应支持多种融合方法，包括但不限于：加权融合、倒数排名融合(RRF)、CombSUM和CombMNZ。
4. 系统应能够学习并记忆不同查询类型的最佳融合策略，用于优化未来的检索。

### 需求5：级联检索策略

**用户故事:** 作为一名RAG系统用户，我希望系统能够在保持高准确率的同时提高检索效率，以便获得更快的响应速度。

#### 验收标准

1. 当执行复杂查询时，系统应实现两阶段检索策略：先用轻量级索引筛选候选集，再用精确索引重排序。
2. 当评估检索性能时，级联检索策略应比单阶段检索在相同准确率下，检索速度提升至少40%。
3. 系统应允许配置候选集大小和重排序深度，以平衡效率和准确性。
4. 如果第一阶段检索结果置信度高于阈值，系统应跳过第二阶段重排序，直接返回结果。

### 需求6：评估框架

**用户故事:** 作为一名研究人员，我希望有一个全面的评估框架来测试不同索引方法的性能，以便进行公平比较和分析。

#### 验收标准

1. 系统应支持在多个标准数据集上评估索引性能，包括但不限于：nfcorpus、trec-covid、scifact等。
2. 系统应计算多种评估指标，包括：准确率、召回率、MRR、NDCG、检索时间等。
3. 系统应支持不同索引方法的对比实验和消融实验。
4. 系统应生成详细的评估报告，包括性能指标、统计分析和可视化图表。
5. 系统应支持不同查询类型的分组评估，以分析各索引方法在不同查询场景下的表现。

## 非功能需求

1. **性能要求**：系统应在CPU环境下运行良好，不依赖GPU资源。
2. **可扩展性**：系统应支持添加新的索引方法和融合策略。
3. **可配置性**：系统应提供丰富的配置选项，允许用户根据需求调整参数。
4. **兼容性**：系统应与现有的RAG框架兼容，能够无缝集成。
5. **可维护性**：代码应有良好的文档和注释，便于理解和维护。